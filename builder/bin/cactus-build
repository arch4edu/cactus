#!/bin/zsh
set -ex

# Pre build
pre_build=$(yq -r '.pre_build' cactus.yaml)
[ $(echo $pre_build | wc -l) -gt 1 ] && pre_build=$(echo $pre_build | jq -r '.[]')
eval $pre_build
ls > .cactus_filelist

# PKGBUILD fixes
sed -e '/^PKGEXT=/d' -e '/^groups=(/d' -i PKGBUILD

# Recieve GPG keys
recv-gpg-keys

# Build the package
build_prefix=$(yq -r .build_prefix cactus.yaml)
for i in $(find depends -name "*.pkg.tar.zst")
do
	depends="$depends -I $i"
done
depends=${depends# }
eval $build_prefix-build -- $depends -- --noprogressbar

# Post build
post_build=$(yq -r '.post_build' cactus.yaml)
[ $(echo $post_build | wc -l) -gt 1 ] && post_build=$(echo $post_build | jq -r '.[]')
eval $post_build
rm -f .cactus_filelist
