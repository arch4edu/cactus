#!/bin/zsh
set -e

# Pre build
pre_build=$(yq -r '.pre_build' cactus.yaml)
[ $(echo $pre_build | wc -l) -gt 1 ] && pre_build=$(echo $pre_build | jq -r '.[]')
echo $pre_build | sh
ls > .cactus_filelist

# PKGBUILD fixes
sed -e '/^PKGEXT=/d' -e '/^groups=(/d' -i PKGBUILD

# Recieve GPG keys
recv-gpg-keys

# Build the package
build_prefix=$(yq -r .build_prefix cactus.yaml)
$build_prefix-build -- -- --noprogressbar

# Post build
post_build=$(yq -r '.post_build' cactus.yaml)
[ $(echo $post_build | wc -l) -gt 1 ] && post_build=$(echo $post_build | jq -r '.[]')
echo $post_build | sh
rm -f .cactus_filelist
