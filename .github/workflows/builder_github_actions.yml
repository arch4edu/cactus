name: Builder (Github Actions)

on:
  workflow_dispatch:
    inputs:
      pkgbase:
        description: 'Path to pkgbase'
        required: true

jobs:

  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux
      options: --privileged
      volumes:
        - /sys/fs/cgroup:/sys/fs/cgroup
    env:
      CACTUS_CONFIG: ${{ secrets.CACTUS_CONFIG }}

    steps:
      - uses: arch4edu/cactus/actions/upgrade-archlinux@main

      - name: Install runtime dependencies
        run: pacman -S --noconfirm --needed base-devel devtools dbus git github-cli jq wget pyalpm python-mysqlclient yq zsh

      - uses: arch4edu/cactus/actions/setup-cactus@main

      - name: Export configurations
        id: config
        run: python -m cactus.common.config

      - uses: arch4edu/cactus/actions/update-status@main
        with:
          pkgbase: ${{ github.event.inputs.pkgbase }}
          status: building
          workflow: ${{ github.run_id }}

      - uses: actions/checkout@master
        with:
          repository: ${{ steps.config.outputs.github_repository }}
          path: repository
          token: ${{ steps.config.outputs.github_token }}

      - uses: arch4edu/cactus/actions/config-pacman-repository@main
        with:
          pacman-repository: ${{ steps.config.outputs.pacman_repository }}
          keyring-repository: ${{ steps.config.outputs.pacman_keyring_repository }}
          mirrorlist-repository: ${{ steps.config.outputs.pacman_mirrorlist_repository }}

      - uses: arch4edu/cactus/actions/config-makepkg@main

      - uses: petronny/git-config-user@master
        with:
          path: repository

      - name: Configure GitHub CLI
        run: echo ${{ secrets.GITHUB_TOKEN }} | gh auth login --with-token

      - name: Add path
        run: echo "$(realpath cactus/builder/bin)" >> $GITHUB_PATH

      - name: Download dependencies
        run:
          python -m cactus.builder.download-depends repository ${{ github.event.inputs.pkgbase }}

      - name: Build
        id: build
        run: |
          chown -R makepkg:root repository
          cd repository/${{ github.event.inputs.pkgbase }}
          su makepkg -c cactus-build | tee build.log
          if [ $(grep -c '==> Running checkpkg' build.log) -gt 0 ]
          then
            echo ::set-output name=result::built
          else
            echo ::set-output name=result::error
          fi

      - name: Fix package name
        if: ${{ steps.build.outputs.result == 'built' }}
        run: |
          cd repository/${{ github.event.inputs.pkgbase }}
          for i in *.pkg.tar.zst
          do
            [ $(echo $i | grep : -c) -gt 0 ] && mv $i $(echo $i | sed 's/:/COLON/g') || continue
          done

      - name: Upload build log
        uses: actions/upload-artifact@master
        if: ${{ always() }}
        with:
          name: ${{ github.run_id }}.log
          path: repository/${{ github.event.inputs.pkgbase }}/build.log

      - name: Upload package
        uses: actions/upload-artifact@master
        with:
          name: ${{ github.run_id }}.package
          path: repository/${{ github.event.inputs.pkgbase }}/*.pkg.tar.zst

      - name: Push changes
        if: ${{ steps.build.outputs.result == 'built' }}
        run: |
          cd repository/${{ github.event.inputs.pkgbase }}
          git-push

      - uses: arch4edu/cactus/actions/update-status@main
        if: ${{ always() }}
        with:
          pkgbase: ${{ github.event.inputs.pkgbase }}
          status: ${{ steps.build.outputs.result }}
          workflow: ${{ github.run_id }}

      - uses: arch4edu/cactus/actions/clean@main
