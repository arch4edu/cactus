name: Scheduler

on:
  workflow_dispatch:

jobs:

  schedule:
    runs-on: ubuntu-latest
    container:
      image: archlinux
    env:
      CACTUS_CONFIG: ${{ secrets.CACTUS_CONFIG }}

    steps:
      - uses: arch4edu/cactus/actions/upgrade-archlinux@main

      - name: Install runtime dependencies
        run: pacman -S --noconfirm --needed git python-django python-mysqlclient python-pygithub python-tornado python-yaml

      - uses: actions/checkout@master
        with:
          path: cactus

      - uses: actions/checkout@master
        with:
          repository: petronny/djangorm
          path: djangorm

      - name: Export config
        id: config
        run: python -m cactus.common.config

      - uses: actions/checkout@master
        with:
          repository: ${{ steps.config.outputs.github_repository }}
          path: repository

      - name: Scheduling
        run: |
          for i in $(seq 66)
          do
            (cd repository; git pull --rebase)
            python -m cactus.scheduler.schedule repository
            sleep 300
          done

      - name: Start a new scheduler
        #if: ${{ always() }}
        run: python -m cactus.scheduler.refresh
